### 基于Docker的部署

前面我们讲过了如何利用Docker打造一个前端开发环境，除了开发，部署算是Docker更主要的应用场景了。所以今天我们就来聊聊如何利用Docker部署我们的前端应用，其实这算是运维的活了，但是我觉得身为一个前端还是很有必要了解的，做一个全栈工程师绝对不是一件坏事。

**目的**

在部署中使用Docker的最主要的目的就是隔离应用的运行环境，无需在线上服务器中重复手动安装环境，是集群分布式部署的基础设施。

传统的部署方式需要在线上服务器中安装运行应用的环境，目前的前端应用大多数情况下是需要安装Node.js用来构建应用的，如果哪天换了一个服务器，是不是又得再安装一遍？其实安装Node.js还不算太麻烦，如果有了解PHP的同学，安装一个环境是相当麻烦的，各种扩展安装起来会累死人。

Docker恰好解决了这个问题，线上服务器只需要安装一个Docker，而各种环境都不需要再手动安装了，类似Node.js这样的环境会在构建镜像的时候安装好，线上服务器只需要用Docker来运行即可，非常方便。

**模式**

我们讲过的Docker开发环境是将源码挂载到容器中运行的。部署其实也可以这样来做，在线上服务器中运行对应的容器，将目标代码挂载进去，然后每次更新代码即可。

但是还有另外一种更好的方式，就是将代码复制到容器中作为一个完整的镜像，然后不管将这个镜像扔到哪儿运行都没问题。

简单说，第一种方式的镜像是一个纯环境，而第二种方式是环境+源码。

这个和我们前端用到的组件化有点相似，组件可以是纯UI的，比如轮播，使用组件的时候需要将数据传入。而另外一种是像热门新闻这样的，是UI+数据，也就是在组件中去请求数据，所以这种组件放到哪儿都是可以完整运行的，无需额外的数据。

**流程**

基于Docker的部署流程其实是有很多种的，今天我们就讲一个简单的完整镜像部署流程，比如我们开发了一个Vue.js的应用

**1、创建Dockerfile**

Dockerfile是一种构建镜像的方式，通过特定的语言格式描述构建镜像的过程，和package.json的作用类似。

所以我们需要在项目根目录下创建一个名为Dockerfile的文件：

```
FROM NODE:8.11

COPY ./app
WORKDIR /app

RUN npm install -g cnpm --registry=https://registry.npm.taobao.org
RUN cnpm install
RUN npm run build

CMD ["npm", "start"]
```

`FROM`表示基础镜像是node，版本是8.11

`COPY`将源码复制到镜像中

`WORKDIR`设置工作目录为源码根目录，也是下面运行命令的根目录

`RUN`用来运行命令。这里我们先安装了cnpm（国内通过cnpm安装依赖更快），然后再安装项目依赖，最后再build

`CMD`表示运行容器的启动命令，这里我们执行的是`npm start`，当然可以根据自己的需要来确定。

由于Docker镜像是分层构建的，从上到下，不变的部分会走缓存，一旦发现有变化的，下面的都会再重新执行一次，依照上面的写法，从上到下会变的首个地方在复制源码这里

```
COPY ./app
```

因为源码每次都会变，这就导致了下面的安装cnpm这一步每次都重新安装，所以是需要优化的。

包括cnpm install，其实`package.json`文件的变化频率很低，也应该放到上面，我们可以先将package.json文件复制到镜像中安装依赖，然后再复制整个源码。

所以，经过优化后的Dockerfile就变成了

```
FROM NODE:8.11

RUN npm install -g cnpm --registry=https://registry.npm.taobao.org

COPY package.json /app/
WORKDIR /app
RUN cnpm install

COPY ./app
RUN npm run build

CMD ["npm", "start"]
```

这样一来，常规更新每次会运行的就只有下面的这几处了

```
COPY ./app
RUN npm run build

CMD ["npm", "start"]
```

>关于Dockerfile的优化工作是很有必要的，因为这会直接影响到部署耗时。

**2、构建**

每次更新完代码之后，我们可以直接运行下面的命令构建镜像

```
docker build -t vueapp:1.0.
```

这里我们构建了一个名为vueapp，版本号是1.0的镜像，如果想保留历史镜像，可以在每次构建的时候命名不同的版本号，否则可以将版本号设为同一个，避免创建多余的镜像，因为一个包含环境和源码的镜像是很大的，通常在700M左右。

这里用来构建的服务器可以是正式运行应用的服务器，也可以是单独的一个服务器，专门用来做构建用的。当然有条件的话，推荐后者，不会影响正式服务器的运行。

**3、部署镜像**

构建好的镜像放到任何安装了Docker的地方都可以正常运行。如果你的构建服务器和正式运行服务器是同一个服务器，那就直接运行构建好的镜像即可，否则需要将镜像部署到运行服务器。

因为是不同的服务器，可以通过`scp`命令将镜像从构建服务器复制到运行服务器上。

另外一种方式是，先将镜像push到私有的镜像仓库，然后再在运行服务器上面将镜像拉取下来运行。这个私有镜像库可以自己搭建，也可以使用阿里云这样的第三方镜像仓库服务。

**拓展**

上面只是Docker部署的一种简单的流程，感兴趣的同学可以继续深入，结合Jenkins开源构建工具就可以实现持续集成，此外还可以研究一下基于Docker的集群部署。

>学无止境，重在折腾