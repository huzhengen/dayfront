# 图片为什么旋转了？

今天我们来做一个很有意思的实验，在你的 Chrome 浏览器（注意不要用IE）中打开下面的图片地址

https://dayfront.oss-cn-beijing.aliyuncs.com/topic/orientation.jpg

这是一张正常的办公室照片，没什么毛病，接着我们将它放到一个 `<img>` 标签中，新建一个 HTML 文件

```html
<html>
  <body>
    <img src="https://dayfront.oss-cn-beijing.aliyuncs.com/topic/orientation.jpg" width="600px" />
  </body>
</html>
```

打开该 HTML 看看，是不是懵逼了？图片居然旋转了，什么情况？

其实这是一张普通的照片，但是特殊的是这张照片是用 iphone 拍摄的，而且是竖着拍的。如果你手里有 iphone，别犹豫，马上验证一下。

其实做过移动端 H5 页面的同学都应该会遇到这样的问题，做了一个上传头像的功能，结果上传后图片就莫名其妙旋转了，究竟是什么原因呢？接下来我们就来揭开其中的面纱。

大家看一张照片的时候只能看到照片的像素色彩，看不到的其实还有照片的元信息，比如拍照方向、相机设备型号、拍摄时间等，其中有一个和我们今天话题有关的参数就是拍照方向 `Orientation`，当值为 `1` 时就是我们认为的摆正了（下图是 Orientation 所有可能的取值和对应的旋转效果）。

![1541756834533-8542.gif](./1541756834533-8542.gif)

那么 iphone 默认横着拍为正，竖着拍 Orientation 的值就为 6，对照一下上图就能理解为什么开始的照片呈现出这样的旋转效果了。

那么有同学要问了，为什么直接在浏览器中打开同样的照片就没问题呢？难道这和用 `<img>` 标签有什么区别？其实很好理解，这里的 Chrome 浏览器实际上就是一个图片查看器，它会去读取图片的 Orientation 值，发现不为 1 就会做相应的旋转，使其摆正，这样用户看到的也就是正确的显示了。不信你可以用其它的图片查看器打开，显示基本上都是正常的，就是因为这些软件内部做了校正。为什么 IE 浏览器又不行呢？很明显是 IE 浏览器没有做这样的处理。

问题搞清楚了，该怎么解决呢？当然我们可以从不同的角度入手。

### JavaScript 处理

如果用 JavaScript 来处理的话，那就需要拿到图片的 Exif 信息中的 Orientation 值，然后再做对应的旋转，和上面图片查看软件的处理思路一样。不能避免要用到 canvas 来读取图片，总的说来还是比较麻烦的，这里就不细说了。

### CSS 处理

话说能用 CSS 处理的就不要用 JS，难道会有这样的 CSS 属性？还真有，`image-orientation` 用来修正图片的预设方向，其中有一个取值为 `from-image` 会自动根据图片的 Orientation 值进行校正。

我们给开始的 `<img>` 标签加上一个样式

```css
img {
  image-orientation: from-image
}
```

在 Chrome 中打开发现还是没变啊，你是因为目前只有 Firefox 和 IOS 上的 Safari 才支持，有点残忍，不过别着急，还有终极方案。

### 服务器处理

前端不好解决的事可以交给后端解决，实际上我们可以在上传图片接口或者获取图片的时候在后端做类似上面的处理。不过如今基本上都是用云存储的方式来解决资源的存储。

比如阿里云 OSS，对于图片这样的资源，我们可以新建图片样式，比如剪切、压缩图片，而其中就有一个选项是 `自适应方向`，选中即可。实际上就是在图片末尾加上了下面的参数

```
?x-oss-process=image/auto-orient,1
```

测试一下

```html
<html>
  <body>
    <img src="https://dayfront.oss-cn-beijing.aliyuncs.com/topic/orientation.jpg?x-oss-process=image/auto-orient,1" width="600px" />
  </body>
</html>
```

是不是没问题了？经过测试，不一定要用上面的参数，阿里云 OSS 加上任何类型的参数都会自动校正。这种方式的好处就是，不光前端，任何终端拿到的图片都是正确的，因为咱们是在源头上做了处理。

作为一名前端开发者，不要遇到什么问题都想着用前端的手段来解决，事实上咱前端费了九牛二虎之力才能解决的问题，后端很轻松就能搞定，所以全栈的思维很重要。